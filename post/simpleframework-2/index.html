<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>SimpleFramework使用步骤总结 | Sqrt9</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://ayosi1996.github.io/favicon.ico?v=1679230816049">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://ayosi1996.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="
实现：使用SimpleFramework实现热更新方式创建UI面板
注：文章使用的是UGUI的框架
1.下载框架
ulua官方地址：http://www.ulua.org/
SimpleFramework UGUI Github地址：ht..." />
    <meta name="keywords" content="Unity" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://ayosi1996.github.io">
        <img src="https://ayosi1996.github.io/images/avatar.png?v=1679230816049" class="site-logo">
        <h1 class="site-title">Sqrt9</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://ayosi1996.github.io" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://ayosi1996.github.io/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://ayosi1996.github.io/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
          <a class="social-link" href="https://twitter.com/Sqrt9SD" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      Hi there!
    </div>
    <div class="site-footer">
      Powered by Gridea | <a class="rss" href="https://ayosi1996.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">SimpleFramework使用步骤总结</h2>
            <div class="post-date">2017-07-05</div>
            
              <div class="feature-container" style="background-image: url('https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/design_pattern/20200317001653905.jpg')">
              </div>
            
            <div class="post-content" v-pre>
              <!--more-->
<p><strong>实现：使用SimpleFramework实现热更新方式创建UI面板</strong><br>
注：文章使用的是UGUI的框架</p>
<h1 id="1下载框架"><strong>1.下载框架</strong></h1>
<p>ulua官方地址：http://www.ulua.org/<br>
SimpleFramework UGUI Github地址：https://github.com/jarjin/SimpleFramework_UGUI/</p>
<p>下载完成后为项目文件，可直接使用unity打开，目录结构如下图：</p>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003122475.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>Examples/Scenes文件下放的为热更新示例项目，ulua/Examples文件夹下放的为ulua语法教程示例</p>
<h1 id="2新建场景"><strong>2.新建场景</strong></h1>
<ol>
<li>新建一个自己要测试的场景</li>
<li>创建需要热更新的面板Prefab</li>
<li>新建一个GameObject添加Global Generator脚本组件</li>
</ol>
<p>层次面板目录结构：</p>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003144905.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p><font color= red><strong>注意：需要热更新的UI面板要以“Panel”名字结尾</strong></font></p>
<h1 id="3打包文件"><strong>3.打包文件</strong></h1>
<ol>
<li>
<p>将TextFramePanel预制体打包进 textframe.assetbundle</p>
</li>
<li>
<p>单击菜单栏中 Lua/Gen Lua Wrap Files ,如果生成成功在ulua/Source/LuaWrap文件夹下看到许多包裹文件，这些文件原来是没有的。</p>
</li>
<li>
<p>如果修改了注册到Lua中的C#类，需要清除文件缓存，重新生成。单击Lua/Clear LuaBinder File + Wrap Files再接第二步</p>
</li>
<li>
<p>单击菜单栏中Game/Build XXX Resources 打包资源文件</p>
</li>
<li>
<p>打包成功会在项目文件夹中生成StreamingAssets文件夹，目录结构如下：</p>
</li>
</ol>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/2020120600320624.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>注：</p>
<ul>
<li>红框中为我的打包文件，其他为示例项目打包的资源文件</li>
<li>如果目标平台时Android，需要现在Build Settings中切换平台为安卓，然后再重新生成打包</li>
</ul>
<p><font color = red><strong>如果在生成包裹文件后出现以下类似错误：</strong></font></p>
<p>Assets/Source/LuaWrap/xxxWrap.cs(218,21): error CS1061: Type <code>UnityEngine.xxx' does not contain a definition for </code>xxx' and no extension method <code>xxx' of type </code>UnityEngine.xxx' could be found (are you missing a using directive or an assembly reference?)<br>
官方给出的解决方案：因为unity不同平台版本api各不相同，因此不是特别统一，遇到此问题直接删除错误代码即可.</p>
<h1 id="4修改c脚本"><strong>4.修改C#脚本</strong></h1>
<h2 id="1panelmanagercs">1.PanelManager.cs</h2>
<pre><code class="language-c#">Transform Parent {
            get {
                if (parent == null) {
                    GameObject go = GameObject.FindWithTag(&quot;Canvas&quot;);//原标签为&quot;GuiCamera&quot;
                    if (go != null) parent = go.transform;
                }
                return parent;
            }
        }
</code></pre>
<p>因为我的TextFramePanel是直接放在Canvas下的，而原框架中是放在GuiCamera下的，所以我将Canvas添加了一个“Canvas”的标签来作为面板的父物体。</p>
<h2 id="2appviewcs">2.AppView.cs</h2>
<pre><code class="language-c#">void OnGUI() {
        GUI.Label(new Rect(10, 120, 960, 50), message);

        GUI.Label(new Rect(10, 0, 500, 50), &quot;(1) 单击 \&quot;Lua/Gen Lua Wrap Files\&quot;。&quot;);
        GUI.Label(new Rect(10, 20, 500, 50), &quot;(2) 运行Unity游戏&quot;);
        GUI.Label(new Rect(10, 40, 500, 50), &quot;PS: 清除缓存，单击\&quot;Lua/Clear LuaBinder File + Wrap Files\&quot;。&quot;);
        GUI.Label(new Rect(10, 60, 900, 50), &quot;PS: 若运行到真机，请设置Const.DebugMode=false，本地调试请设置Const.DebugMode=true&quot;);
        GUI.Label(new Rect(10, 80, 500, 50), &quot;PS: 加Unity+ulua技术讨论群：&gt;&gt;341746602&quot;);
    }
</code></pre>
<p>这些是框架的提示信息，可自行修改或删除</p>
<h2 id="3appconstcs">3.AppConst.cs</h2>
<pre><code class="language-c#">public const bool DebugMode = false;          //调试模式-用于内部测试，默认为true
public const bool UpdateMode = true;          //更新模式-默认为false
public const string WebUrl = &quot;http://192.168.3.9:6688/&quot;;  //测试更新地址，默认为localhost
</code></pre>
<p>192.168.3.9位本机IP地址</p>
<h2 id="4httpservercs">4.HttpServer.cs</h2>
<p>修改框架自带的服务器端host地址，即Server/Server.sln中的HttpServer.cs</p>
<pre><code class="language-c#">public HttpServer(int port) {
            host = &quot;http://192.168.3.9:6688/&quot;;
        }
</code></pre>
<h1 id="5修改lua脚本"><strong>5.修改Lua脚本</strong></h1>
<h2 id="1打开项目文件夹">1.打开项目文件夹</h2>
<p>这里可以使用Sublime Text 的  File/Open Folder打开框架中的Lua文件夹，能够清楚的看到文件夹结构。<br>
不过第一次打开也会将所有.meta文件显示出来，显得比较乱，可以参考<a href="https://stackoverflow.com/questions/17632108/hide-files-with-certain-extension-in-sublime-text-editor">这里</a>来屏蔽特定文件类型<br>
##2.函数调用顺序<br>
GameManager.cs</p>
<pre><code class="language-c#">        /// &lt;summary&gt;
        /// 资源初始化结束
        /// &lt;/summary&gt;
        public void OnResourceInited() {
            LuaManager.Start();
            LuaManager.DoFile(&quot;Logic/Network&quot;);      //加载游戏
            LuaManager.DoFile(&quot;Logic/GameManager&quot;);   //加载网络
            initialize = true;  

            NetManager.OnInit();    //初始化网络

            object[] panels = CallMethod(&quot;LuaScriptPanel&quot;);
            //---------------------Lua面板---------------------------
            foreach (object o in panels) {
                string name = o.ToString().Trim();
                if (string.IsNullOrEmpty(name)) continue;
                name += &quot;Panel&quot;;    //添加

                LuaManager.DoFile(&quot;View/&quot; + name);
                Debug.LogWarning(&quot;LoadLua----&gt;&gt;&gt;&gt;&quot; + name + &quot;.lua&quot;);
            }
            //------------------------------------------------------------
            CallMethod(&quot;OnInitOK&quot;);   //初始化完成
        }
</code></pre>
<p>从以上可以看出Lua函数的调用顺序为</p>
<pre><code class="language-c#">GameManager.LuaScriptPanel()--&gt;View/TextFramePanel.lua--&gt;GameManager.OnInitOK()
</code></pre>
<p>这里即将控制权交给了Lua文件</p>
<h2 id="3logicgamemangerlua">3.Logic/GameManger.lua</h2>
<pre><code class="language-lua">require &quot;Common/define&quot;
require &quot;Controller/TextFrameCtrl&quot;


GameManager={}
local this = GameManager


function GameManager.LuaScriptPanel()
    return 'TextFrame'
end


function GameManager.OnInitOK()
    AppConst.SocketPort = 2012
    AppConst.SocketAddress = &quot;127.0.0.1&quot;
    NetManager:SendConnect()

    TextFrameCtrl.Awake()
    warn(&quot;SimpleFramework start!&quot;);
end
</code></pre>
<h2 id="4viewtextframepanellua">4.View/TextFramePanel.lua</h2>
<pre><code class="language-lua">local transform
local gameObject

TextFramePanel = {};
local this = TextFramePanel;


function TextFramePanel.Awake(obj)
	-- body
	gameObject = obj
	transform = obj.transform

	this.InitPanel()
end


function TextFramePanel.InitPanel()
	--测试热更新文本
	this.textshow = transform:FindChild(&quot;BG/Text&quot;).gameObject;
end
</code></pre>
<h2 id="5controllertextframectrllua">5.Controller/TextFrameCtrl.lua</h2>
<pre><code class="language-lua">require &quot;Common/define&quot;

local label
local textframe
local transform
local gameObject

TextFrameCtrl = {}
local this = TextFrameCtrl


function TextFrameCtrl.New()
	-- body
	return this
end

function  TextFrameCtrl.Awake()
	-- body
	PanelManager:CreatePanel(&quot;TextFrame&quot;, this.OnCreate);--创建面板，调用回调函数
end

--启动事件--
function TextFrameCtrl.OnCreate(obj)
	-- body
	gameObject = obj
	transform = obj.transform
	label = TextFramePanel.textshow:GetComponent(&quot;Text&quot;)

	label.text = &quot;oh, come on man!&quot;
end
</code></pre>
<h1 id="6启动服务器测试"><strong>6.启动服务器测试</strong></h1>
<h2 id="1build安卓apk">1.Build安卓apk</h2>
<p>当服务器没有打开时，打开APK如下图：<br>
<img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003307310.png" alt="在这里插入图片描述" loading="lazy"></p>
<h2 id="2启动服务器">2.启动服务器</h2>
<p>以管理员方式启动Server\Server\bin\Debug下的SuperSocket.SocketService.exe<br>
启动后显示图：</p>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003340352.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>此时再重启APK：</p>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/2020120600340265.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>ok！</p>
<p>如果更新失败可以测试一下手机是否能连接电脑主机端口，即在浏览器中输入 本机IP:端口号<br>
例如：192.168.3.9:6688 输入后能显示下图即连接成功</p>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003424768.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>如果连接不上可以试试如下方法：<br>
http://jingyan.baidu.com/article/67508eb4dc85e79cca1ce48f.html</p>
<h1 id="7热更新测试">7.热更新测试</h1>
<p>更新内容：修改文本框中的文字为“更新完成”，并且删除面板中间的那张图片</p>
<p>1.修改Controller/TextFrameCtrl.lua</p>
<pre><code class="language-lua">--启动事件--
function TextFrameCtrl.OnCreate(obj)
	-- body
	gameObject = obj
	transform = obj.transform
	label = TextFramePanel.textshow:GetComponent(&quot;Text&quot;)

	label.text = &quot;更新完成&quot;
end
</code></pre>
<p>2.修改TextFramePanel预制体</p>
<p>将预制体中的图片删除，结构如下：</p>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003451181.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>然后重新Build Android Resource，重新启动安卓客户端：</p>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/Ayosi1996/pic/master/blog_imgs/unity_feature/20201206003514754.png" alt="在这里插入图片描述" loading="lazy"></figure>
<p>完！</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://ayosi1996.github.io/tag/8XKEAF2sL/" class="tag">
                    Unity
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://ayosi1996.github.io/post/unity-note-010/">
                  <h3 class="post-title">
                    Character controller在运动的刚体碰撞体上会掉落
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
